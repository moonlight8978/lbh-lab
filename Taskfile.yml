---
version: "3"

vars:
  WORKERS: [worker-1, worker-2]

tasks:
  tf:stack:
    vars: &tf_vars
      workdir: "{{index .CLI_ARGS_LIST 0}}"
      args: '{{slice .CLI_ARGS_LIST 1 | join " "}}'
    dir: "{{.workdir}}"
    cmd: terragrunt stack {{ternary "" "run" (hasPrefix "output" .args)}} {{.args}} --non-interactive --auth-provider-cmd "sops decrypt {{.ROOT_DIR}}/secrets.yml --output-type json"

  tf:unit:
    vars: *tf_vars
    dir: "{{.workdir}}"
    cmd: terragrunt {{.args}} --auth-provider-cmd "sops decrypt {{.ROOT_DIR}}/secrets.yml --output-type json" --all --non-interactive

  sops:dec:
    cmds:
      - sops decrypt secrets.yml > secrets.dec.yml

  sops:enc:
    cmds:
      - sops encrypt secrets.dec.yml > secrets.yml

  talos:secrets:
    cmds:
      - task: sops:dec
      - talosctl gen secrets -o talos-secrets.dec.yml --force
      - |
        cat talos-secrets.dec.yml | yq eval '{ "talos": . }' > /tmp/talos-secrets.dec.yml
      - defer: rm -rf /tmp/secrets.yml /tmp/talos-secrets.yml
      - |
        yq eval-all '. as $item ireduce ({}; . * $item )' /tmp/talos-secrets.yml /tmp/secrets.yml | sops encrypt --input-type yaml --output-type yaml --filename-override secrets.dec.yml > secrets.yml

  talos:config:
    dir: "kubernetes/talos"
    cmds:
      - sops decrypt {{.ROOT_DIR}}/secrets.yml | yq -r '.talos' | talosctl gen config --with-secrets /dev/stdin lbhlab https://10.242.20.160:6443 --config-patch @patch.yaml {{.CLI_ARGS}}
      - talosctl --talosconfig=./talosconfig config endpoints 10.242.20.161
      - talosctl --talosconfig=./talosconfig kubeconfig --nodes 10.242.20.161

  talos:reset:
    vars:
      IP: "{{ index .CLI_ARGS_LIST 0 }}"
    dir: kubernetes/talos
    cmd: talosctl reset --nodes {{.IP}} --talosconfig talosconfig --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL

  # controlplane or worker
  talos:apply:*:
    vars:
      ROLE: "{{ index .MATCH 0 }}"
      MACHINE: "{{ index .CLI_ARGS_LIST 0 }}"
      IP: "{{ index .CLI_ARGS_LIST 1 }}"
      ARGS: '{{slice .CLI_ARGS_LIST 2 | join " "}}'
    dir: kubernetes/talos
    cmds:
      - talosctl machineconfig patch {{.ROLE}}.yaml -p @patch.yaml -p @nodes/{{.MACHINE}}.yaml | talosctl apply-config --file /dev/stdin --nodes {{.IP}} {{.ARGS}}

  talos:reboot:
    vars:
      IP: "{{ index .CLI_ARGS_LIST 0 }}"
    dir: kubernetes/talos
    cmds:
      - talosctl reboot --nodes {{.IP}} --talosconfig talosconfig

  talos:bootstrap:
    dir: kubernetes/talos
    cmds:
      - task: talos:apply:controlplane
        vars:
          CLI_ARGS_LIST: [control-1, 10.242.20.161, --insecure]
      - task: talos:apply:controlplane
        vars:
          CLI_ARGS_LIST: [control-2, 10.242.20.162, --insecure]
      - task: talos:apply:controlplane
        vars:
          CLI_ARGS_LIST: [control-3, 10.242.20.163, --insecure]
      - task: talos:apply:worker
        vars:
          CLI_ARGS_LIST:
            [worker-1, 10.242.20.171, --insecure -p @nodes/storage.yaml]
      - task: talos:apply:worker
        vars:
          CLI_ARGS_LIST:
            [worker-2, 10.242.20.172, --insecure -p @nodes/storage.yaml]
      - task: talos:apply:worker
        vars:
          CLI_ARGS_LIST:
            [worker-3, 10.242.20.173, --insecure -p @nodes/storage.yaml]
      - sleep 10
      - talosctl bootstrap --talosconfig talosconfig --nodes 10.242.20.161
      - talosctl kubeconfig --talosconfig talosconfig --nodes 10.242.20.161
      - yq -i '.clusters[0].cluster.server = "https://10.242.20.161:6443"' kubeconfig

  talosctl:
    dir: kubernetes/talos
    cmds:
      - talosctl --talosconfig=./talosconfig --nodes {{.CLI_ARGS}}

  k8s:noderole:
    env:
      KUBECONFIG: "{{.ROOT_DIR}}/kubernetes/k0s/kubeconfig"
    cmds:
      - for: { var: WORKERS }
        cmd: kubectl label node {{.ITEM}} node-role.kubernetes.io/worker=worker
      - for: { var: WORKERS }
        cmd: kubectl label node {{.ITEM}} node-role.kubernetes.io/openebs=openebs
      - for: [worker-1]
        cmd: kubectl label node {{.ITEM}} node-role.kubernetes.io/nas=nas

  k8s:bootstrap:
    dir: kubernetes/charts
    cmds:
      - helmfile sync --wait --hide-notes
    env:
      KUBECONFIG: "{{.ROOT_DIR}}/kubernetes/k0s/kubeconfig"

  argocd:login:
    env:
      KUBECONFIG: "{{.ROOT_DIR}}/kubernetes/k0s/kubeconfig"
    cmds:
      - |
        PASSWORD=$(sops decrypt {{.ROOT_DIR}}/secrets.yml | yq -r '.argocd_password')
        argocd login 10.242.20.181 --username admin --password $PASSWORD --insecure

  argocd:bootstrap:
    cmds:
      - task: argocd:login
      - for: [core, system]
        cmd: argocd app sync --project {{.ITEM}}

  bootstrap:
    cmds:
      - task: tf:unit
        vars:
          CLI_ARGS_LIST: [prod/kubernetes, apply]
      # TODO: wait for machines
      - task: k0s:bootstrap
      # TODO: wait for nodes to be ready
      - task: k8s:noderole
      - task: k8s:bootstrap
      - task: argocd:bootstrap

  secret:update:
    cmds:
      - task: sops:enc
      - task: tf:unit
        vars:
          CLI_ARGS_LIST: [prod/bitwarden, apply]

  schema:
    cmds:
      - kss sync --auth-method kubeconfig --kubeconfig kubernetes/k0s/kubeconfig --destination dist

  vm:
    cmds:
      - task: tf:unit
        vars:
          CLI_ARGS_LIST: [prod/network, apply]
      - task: ansible-playbook -i inventory.yml ansible/playbooks/setup-network.yml

  ansible:run:
    cmds:
      - ansible-playbook -i inventory.yml ansible/playbooks/{{.CLI_ARGS}}

  ansible:init:
    cmds:
      - ansible-galaxy install -r requirements.yml

  cloudinit:passwd:
    cmd: mkpasswd --method=SHA-512 --rounds=4096

  k0s:bootstrap:
    dir: kubernetes/k0s
    cmds:
      - k0sctl apply --no-wait
      - task: k0s:kubeconf
      - until kubectl get node worker-1 worker-2 > /dev/null 2>&1; do sleep 5; done
      - task: k8s:noderole

  k0s:reset:
    dir: kubernetes/k0s
    cmds:
      - k0sctl reset

  k0s:kubeconf:
    dir: kubernetes/k0s
    cmds:
      - k0sctl kubeconfig > kubeconfig

  bin:
    cmds:
      - chmod +x scripts/*

  bin:run:
    cmds:
      - scripts/{{.CLI_ARGS}}
