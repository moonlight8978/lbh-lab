# yaml-language-server: $schema=https://raw.githubusercontent.com/moonlight8978/lbh-lab/refs/heads/jsonschema/external-secrets.io/externalsecret-v1.json

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: dex-config
  namespace: application
  annotations:
    argocd.argoproj.io/sync-wave: "-100"
spec:
  secretStoreRef:
    name: bitwarden
    kind: ClusterSecretStore
  target:
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      data:
        config.docker.yaml: |
          issuer: {{.baseUrl}}

          frontend:
            issuer: Sweet Home

          storage:
            type: sqlite3
            config:
              file: /var/dex/dex.db

          web:
            http: 0.0.0.0:5556
            clientRemoteIP:
              header: X-Forwarded-For
              trustedProxies:
                - 10.0.0.0/8
                - 192.168.0.0/16
                - 173.245.48.0/20
                - 103.21.244.0/22
                - 103.22.200.0/22
                - 103.31.4.0/22
                - 141.101.64.0/18
                - 108.162.192.0/18
                - 190.93.240.0/20
                - 188.114.96.0/20
                - 197.234.240.0/22
                - 198.41.128.0/17
                - 162.158.0.0/15
                - 104.16.0.0/13
                - 104.24.0.0/14
                - 172.64.0.0/13
                - 131.0.72.0/22
          expiry:
            idTokens: 168h
            refreshTokens:
              reuseInterval: 5s
              validIfNotUsedFor: 2160h
              absoluteLifetime: 3960h

          staticClients:
            - id: oauth2proxy
              name: OAuth2 Proxy
              redirectURIs:
                - {{.oauth2proxyUrl}}/oauth2/callback
              secret: {{.oauth2proxyClientSecret}}

          oauth2:
            skipApprovalScreen: true

          connectors:
            - id: google
              type: google
              name: Google
              config:
                clientID: {{.googleClientId}}
                clientSecret: {{.googleClientSecret}}
                redirectURI: {{.baseUrl}}/callback

            - id: github
              type: github
              name: GitHub
              config:
                clientID: {{.githubClientId}}
                clientSecret: {{.githubClientSecret}}
                redirectURI: {{.baseUrl}}/callback
                useLoginAsID: true

            - id: pocket-id
              type: oidc
              name: Pocket ID
              config:
                issuer: {{.pocketIdUrl}}
                clientID: {{.pocketIdClientId}}
                clientSecret: {{.pocketIdClientSecret}}
                redirectURI: {{.baseUrl}}/callback
  refreshPolicy: Periodic
  refreshInterval: 1h
  dataFrom:
    - extract:
        key: dex/app
